name: CD
on:
  workflow_dispatch:
    inputs:
      EC2_IP:
        description: "The IP address of the Kind EC2 instance"
        required: true

jobs:
  Deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code #git clone
        uses: actions/checkout@v3

      - name: Copy Repo to Kind EC2
        run: |
          # Save the SSH private key to a file
          echo "${{ secrets.SSH_KEY }}" > key.pem
          chmod 400 key.pem

          # Use rsync to copy the repository, excluding key.pem
          rsync -avz -e "ssh -i key.pem -o StrictHostKeyChecking=no" --exclude 'key.pem' ./ ec2-user@${{ inputs.EC2_HOST }}:~/repo

      - name: Deploy to kind Cluster
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ inputs.EC2_IP}}
          username: ec2-user
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
              # Update the system and ensure Docker and kubectl are installed
              sudo yum update -y
              sudo systemctl start docker

              # Set kubeconfig to access the Kind cluster
              export KUBECONFIG="$(kind get kubeconfig-path --name="kind-cluster")"

              # Verify kubectl connectivity
              kubectl cluster-info

              # Create namespace for the application if not exists
              kubectl create namespace my-app || true

              # Deploy the application using Helm
              helm repo add my-app-repo https://example.com/helm-charts
              helm repo update
              helm upgrade --install my-app my-app-repo/my-app-chart \
                --namespace my-app \
                --set image.tag=latest \
                --set mysql.rootPassword=your-password

              # Apply MySQL YAML file
              kubectl apply -f mysql-deployment.yaml -n my-app

              # Verify deployments
              kubectl get pods -n my-app
                        
